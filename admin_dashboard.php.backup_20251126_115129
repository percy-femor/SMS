<?php
session_start();
if (!isset($_SESSION['admin_id'])) {
    header('Location: login.php');
    exit();
}

require_once 'db_config.php';

$success = '';
$error = '';

// Handle form submissions
if ($_SERVER['REQUEST_METHOD'] == 'POST') {

    // Register Teacher
    if (isset($_POST['register_teacher'])) {
        $email = $_POST['email'];
        $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
        $full_name = $_POST['full_name'];
        $phone = $_POST['phone'] ?? '';
        $subject = $_POST['subject'] ?? '';
        $sex = $_POST['sex'] ?? null;

        $passportPath = null;
        if (isset($_FILES['passport']) && $_FILES['passport']['error'] === UPLOAD_ERR_OK) {
            $allowedTypes = ['image/jpeg' => '.jpg', 'image/png' => '.png', 'image/gif' => '.gif', 'image/webp' => '.webp'];

            // Create upload directory if it doesn't exist
            $uploadDir = __DIR__ . DIRECTORY_SEPARATOR . 'uploads' . DIRECTORY_SEPARATOR . 'passports';
            if (!is_dir($uploadDir)) {
                if (!mkdir($uploadDir, 0775, true)) {
                    $error = 'Failed to create upload directory for passports.';
                }
            }

            if (!$error) {
                // Check file type using a safer method
                $finfo = new finfo(FILEINFO_MIME_TYPE);
                $fileType = $finfo->file($_FILES['passport']['tmp_name']);

                if (isset($allowedTypes[$fileType])) {
                    $ext = $allowedTypes[$fileType];
                    $fileName = 'teacher_' . uniqid() . $ext;
                    $dest = $uploadDir . DIRECTORY_SEPARATOR . $fileName;

                    if (move_uploaded_file($_FILES['passport']['tmp_name'], $dest)) {
                        $passportPath = 'uploads/passports/' . $fileName;
                    } else {
                        $error = 'Failed to save uploaded passport for teacher. Error: ' . error_get_last()['message'];
                    }
                } else {
                    $error = 'Invalid image type: ' . $fileType . '. Allowed: JPG, PNG, GIF, WEBP';
                }
            }
        }

        if (!$error) {
            try {
                $stmt = $pdo->prepare("INSERT INTO teachers (email, password, full_name, phone, subject, sex, passport_path) VALUES (?, ?, ?, ?, ?, ?, ?)");
                $stmt->execute([$email, $password, $full_name, $phone, $subject, $sex, $passportPath]);
                $success = "Teacher registered successfully!";
            } catch (PDOException $e) {
                $error = "Error registering teacher: " . $e->getMessage();
            }
        }
    }

    // Update Teacher
    if (isset($_POST['update_teacher'])) {
        $teacher_id = $_POST['teacher_id'];
        $email = $_POST['email'];
        $full_name = $_POST['full_name'];
        $phone = $_POST['phone'] ?? '';
        $subject = $_POST['subject'] ?? '';

        try {
            $stmt = $pdo->prepare("UPDATE teachers SET email = ?, full_name = ?, phone = ?, subject = ? WHERE id = ?");
            $stmt->execute([$email, $full_name, $phone, $subject, $teacher_id]);
            $success = "Teacher updated successfully!";
        } catch (PDOException $e) {
            $error = "Error updating teacher: " . $e->getMessage();
        }
    }

    // Register Student
    if (isset($_POST['register_student'])) {
        $email = $_POST['email'];
        $password = password_hash($_POST['password'], PASSWORD_DEFAULT);
        $full_name = $_POST['full_name'];
        $class_id = $_POST['class_id'];
        $sex = $_POST['sex'] ?? null;

        $passportPath = null;
        if (isset($_FILES['passport']) && $_FILES['passport']['error'] === UPLOAD_ERR_OK) {
            $allowedTypes = ['image/jpeg' => '.jpg', 'image/png' => '.png', 'image/gif' => '.gif', 'image/webp' => '.webp'];

            // Create upload directory if it doesn't exist
            $uploadDir = __DIR__ . DIRECTORY_SEPARATOR . 'uploads' . DIRECTORY_SEPARATOR . 'passports';
            if (!is_dir($uploadDir)) {
                if (!mkdir($uploadDir, 0775, true)) {
                    $error = 'Failed to create upload directory for passports.';
                }
            }

            if (!$error) {
                // Check file type using a safer method
                $finfo = new finfo(FILEINFO_MIME_TYPE);
                $fileType = $finfo->file($_FILES['passport']['tmp_name']);

                if (isset($allowedTypes[$fileType])) {
                    $ext = $allowedTypes[$fileType];
                    $fileName = 'student_' . uniqid() . $ext;
                    $dest = $uploadDir . DIRECTORY_SEPARATOR . $fileName;

                    if (move_uploaded_file($_FILES['passport']['tmp_name'], $dest)) {
                        $passportPath = 'uploads/passports/' . $fileName;
                    } else {
                        $error = 'Failed to save uploaded passport for student. Error: ' . error_get_last()['message'];
                    }
                } else {
                    $error = 'Invalid image type: ' . $fileType . '. Allowed: JPG, PNG, GIF, WEBP';
                }
            }
        }

        if (!$error) {
            try {
                // Check class capacity
                $stmt = $pdo->prepare("SELECT current_enrollment, max_capacity FROM classes WHERE class_id = ?");
                $stmt->execute([$class_id]);
                $class = $stmt->fetch();

                if ($class && $class['current_enrollment'] < $class['max_capacity']) {
                    // Insert student
                    $stmt = $pdo->prepare("INSERT INTO students (email, password, full_name, class_id, sex, passport_path) VALUES (?, ?, ?, ?, ?, ?)");
                    $stmt->execute([$email, $password, $full_name, $class_id, $sex, $passportPath]);

                    // Update class enrollment
                    $stmt = $pdo->prepare("UPDATE classes SET current_enrollment = current_enrollment + 1 WHERE class_id = ?");
                    $stmt->execute([$class_id]);

                    $success = "Student registered successfully!";
                } else {
                    $error = "Class is full! Maximum capacity reached.";
                }
            } catch (PDOException $e) {
                $error = "Error registering student: " . $e->getMessage();
            }
        }
    }

    // Create Class
    if (isset($_POST['create_class'])) {
        $class_name = $_POST['class_name'];
        $class_code = $_POST['class_code'];
        $teacher_id = $_POST['teacher_id'] ?: NULL;

        try {
            $stmt = $pdo->prepare("INSERT INTO classes (class_name, class_code, teacher_id) VALUES (?, ?, ?)");
            $stmt->execute([$class_name, $class_code, $teacher_id]);
            $success = "Class created successfully!";
        } catch (PDOException $e) {
            $error = "Error creating class: " . $e->getMessage();
        }
    }

    // Assign Teacher to Class
    if (isset($_POST['assign_teacher'])) {
        $class_id = $_POST['class_id'];
        $teacher_id = $_POST['teacher_id'] ?: NULL;

        try {
            $stmt = $pdo->prepare("UPDATE classes SET teacher_id = ? WHERE class_id = ?");
            $stmt->execute([$teacher_id, $class_id]);
            $success = "Teacher assigned to class successfully!";
        } catch (PDOException $e) {
            $error = "Error assigning teacher: " . $e->getMessage();
        }
    }

    // Remove Student from Class
    if (isset($_POST['remove_student'])) {
        $student_id = $_POST['student_id'];
        $class_id = $_POST['class_id'];

        try {
            // Remove student from class
            $stmt = $pdo->prepare("UPDATE students SET class_id = NULL WHERE id = ?");
            $stmt->execute([$student_id]);

            // Update class enrollment
            $stmt = $pdo->prepare("UPDATE classes SET current_enrollment = current_enrollment - 1 WHERE class_id = ?");
            $stmt->execute([$class_id]);

            $success = "Student removed from class successfully!";
        } catch (PDOException $e) {
            $error = "Error removing student: " . $e->getMessage();
        }
    }

    // Record Fee Payment
    if (isset($_POST['record_payment'])) {
        $student_id = $_POST['student_id'];
        $amount = $_POST['amount'];
        $payment_date = $_POST['payment_date'];
        $term = $_POST['term'];
        $academic_year = $_POST['academic_year'];
        $fee_type_id = $_POST['fee_type_id'] ?? null;

        try {
            $stmt = $pdo->prepare("INSERT INTO fee_payments (student_id, amount, payment_date, term, academic_year, fee_type_id) VALUES (?, ?, ?, ?, ?, ?)");
            $stmt->execute([$student_id, $amount, $payment_date, $term, $academic_year, $fee_type_id]);
            $success = "Fee payment recorded successfully!";
        } catch (PDOException $e) {
            $error = "Error recording payment: " . $e->getMessage();
        }
    }

    // Create Announcement
    if (isset($_POST['create_announcement'])) {
        $title = $_POST['title'] ?? '';
        $message = $_POST['message'] ?? '';
        $recipient_type = $_POST['recipient_type'] ?? '';
        $priority = $_POST['priority'] ?? 'medium';
        $admin_id = $_SESSION['admin_id'];

        // Validate required fields
        if (empty($title) || empty($message) || empty($recipient_type)) {
            $error = "Please fill in all required fields for the announcement.";
        } else {
            try {
                if ($recipient_type === 'teachers') {
                    $stmt = $pdo->prepare("INSERT INTO teacher_announcements (title, message, priority, created_by) VALUES (?, ?, ?, ?)");
                } else {
                    $stmt = $pdo->prepare("INSERT INTO student_announcements (title, message, priority, created_by) VALUES (?, ?, ?, ?)");
                }
                $stmt->execute([$title, $message, $priority, $admin_id]);
                $success = "Announcement created successfully for $recipient_type!";
            } catch (PDOException $e) {
                $error = "Error creating announcement: " . $e->getMessage();
            }
        }
    }
}

//codes for the store
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // Add Store Item
    if (isset($_POST['add_store_item'])) {
        $error = ''; // Initialize error variable
        $name = trim($_POST['name'] ?? '');
        $description = trim($_POST['description'] ?? '');
        $category = trim($_POST['category'] ?? '');
        $price = $_POST['price'] ?? '';
        $quantity = isset($_POST['quantity']) ? (int)$_POST['quantity'] : 0;
        $is_available = isset($_POST['is_available']) ? 1 : 0;

        // Validate required fields
        if (empty($name)) {
            $error = 'Item name is required.';
        } elseif (empty($category)) {
            $error = 'Category is required.';
        } elseif (empty($price) || !is_numeric($price) || $price < 0) {
            $error = 'Valid price is required.';
        }

        $imagePath = null;
        if (empty($error) && isset($_FILES['item_image']) && $_FILES['item_image']['error'] === UPLOAD_ERR_OK) {
            $allowedTypes = ['image/jpeg' => '.jpg', 'image/png' => '.png', 'image/gif' => '.gif', 'image/webp' => '.webp'];

            $uploadDir = __DIR__ . DIRECTORY_SEPARATOR . 'uploads' . DIRECTORY_SEPARATOR . 'store';
            if (!is_dir($uploadDir)) {
                if (!mkdir($uploadDir, 0775, true)) {
                    $error = 'Failed to create upload directory for store images.';
                }
            }

            if (empty($error)) {
                $finfo = new finfo(FILEINFO_MIME_TYPE);
                $fileType = $finfo->file($_FILES['item_image']['tmp_name']);

                if (isset($allowedTypes[$fileType])) {
                    $ext = $allowedTypes[$fileType];
                    $fileName = 'store_' . uniqid() . $ext;
                    $dest = $uploadDir . DIRECTORY_SEPARATOR . $fileName;

                    if (move_uploaded_file($_FILES['item_image']['tmp_name'], $dest)) {
                        $imagePath = 'uploads/store/' . $fileName;
                    } else {
                        $error = 'Failed to save uploaded image. Error: ' . (error_get_last()['message'] ?? 'Unknown error');
                    }
                } else {
                    $error = 'Invalid image type. Allowed: JPG, PNG, GIF, WEBP';
                }
            }
        }

        if (empty($error)) {
            try {
                $stmt = $pdo->prepare("INSERT INTO store_items (name, description, category, price, quantity_available, image_url, is_available, created_by) VALUES (?, ?, ?, ?, ?, ?, ?, ?)");
                $stmt->execute([$name, $description, $category, $price, $quantity, $imagePath, $is_available, $_SESSION['admin_id']]);
                $success = "Store item added successfully!";
            } catch (PDOException $e) {
                $error = "Error adding store item: " . $e->getMessage();
            }
        }
    }

    // Update Store Item
    if (isset($_POST['update_store_item'])) {
        $error = ''; // Initialize error variable
        $item_id = isset($_POST['item_id']) ? (int)$_POST['item_id'] : 0;
        $name = trim($_POST['name'] ?? '');
        $description = trim($_POST['description'] ?? '');
        $category = trim($_POST['category'] ?? '');
        $price = $_POST['price'] ?? '';
        $quantity = isset($_POST['quantity']) ? (int)$_POST['quantity'] : 0;
        $is_available = isset($_POST['is_available']) ? 1 : 0;

        // Validate required fields
        if (empty($item_id) || $item_id <= 0) {
            $error = 'Invalid item ID.';
        } elseif (empty($name)) {
            $error = 'Item name is required.';
        } elseif (empty($category)) {
            $error = 'Category is required.';
        } elseif (empty($price) || !is_numeric($price) || $price < 0) {
            $error = 'Valid price is required.';
        }

        if (empty($error)) {
            try {
                // First verify the item exists
                $checkStmt = $pdo->prepare("SELECT id FROM store_items WHERE id = ?");
                $checkStmt->execute([$item_id]);
                if (!$checkStmt->fetch()) {
                    $error = 'Store item not found.';
                } else {
                    $stmt = $pdo->prepare("UPDATE store_items SET name = ?, description = ?, category = ?, price = ?, quantity_available = ?, is_available = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?");
                    $stmt->execute([$name, $description, $category, $price, $quantity, $is_available, $item_id]);
                    $success = "Store item updated successfully!";
                }
            } catch (PDOException $e) {
                $error = "Error updating store item: " . $e->getMessage();
            }
        }
    }

    // Clear Old Orders
    if (isset($_POST['clear_old_orders'])) {
        $days_old = $_POST['days_old'] ?? 30;

        try {
            // Calculate the date threshold
            $threshold_date = date('Y-m-d H:i:s', strtotime("-$days_old days"));

            // Count orders to be deleted
            $stmt = $pdo->prepare("SELECT COUNT(*) FROM store_orders WHERE order_date < ? AND status IN ('completed', 'cancelled')");
            $stmt->execute([$threshold_date]);
            $orders_to_delete = $stmt->fetchColumn();

            if ($orders_to_delete > 0) {
                // Delete old orders
                $stmt = $pdo->prepare("DELETE FROM store_orders WHERE order_date < ? AND status IN ('completed', 'cancelled')");
                $stmt->execute([$threshold_date]);

                $success = "Successfully cleared $orders_to_delete old orders (older than $days_old days)!";
            } else {
                $success = "No old orders found to clear (older than $days_old days).";
            }
        } catch (PDOException $e) {
            $error = "Error clearing old orders: " . $e->getMessage();
        }
    }

    // Clear Specific Order
    if (isset($_POST['clear_single_order'])) {
        $order_id = $_POST['order_id'];

        try {
            $stmt = $pdo->prepare("DELETE FROM store_orders WHERE id = ?");
            $stmt->execute([$order_id]);
            $success = "Order #$order_id has been cleared successfully!";
        } catch (PDOException $e) {
            $error = "Error clearing order: " . $e->getMessage();
        }
    }

    // Update Order Status
    if (isset($_POST['update_order_status'])) {
        $order_id = $_POST['order_id'];
        $new_status = $_POST['status'];

        try {
            $stmt = $pdo->prepare("UPDATE store_orders SET status = ? WHERE id = ?");
            $stmt->execute([$new_status, $order_id]);
            $success = "Order #$order_id status updated to " . ucfirst($new_status) . " successfully!";
        } catch (PDOException $e) {
            $error = "Error updating order status: " . $e->getMessage();
        }
    }
}

// Get store data
try {
    $store_items = $pdo->query("SELECT * FROM store_items ORDER BY created_at DESC")->fetchAll();
} catch (PDOException $e) {
    $store_items = [];
    $error = "Error loading store items: " . $e->getMessage();
}

try {
    $store_orders = $pdo->query("SELECT so.*, s.full_name as student_name, s.email as student_email, si.name as item_name, si.price as item_price FROM store_orders so JOIN students s ON so.student_id = s.id JOIN store_items si ON so.item_id = si.id ORDER BY so.order_date DESC")->fetchAll();
} catch (PDOException $e) {
    $store_orders = [];
    $error = "Error loading store orders: " . $e->getMessage();
}

// Get data for dropdowns and listings
$teachers = $pdo->query("SELECT * FROM teachers ORDER BY full_name")->fetchAll();
$classes = $pdo->query("SELECT c.*, t.full_name as teacher_name FROM classes c LEFT JOIN teachers t ON c.teacher_id = t.id ORDER BY c.class_name")->fetchAll();
$students = $pdo->query("SELECT s.*, c.class_name, c.class_code FROM students s LEFT JOIN classes c ON s.class_id = c.class_id ORDER BY s.full_name")->fetchAll();

// Get fee types
try {
    // First check if the table exists
    $tableExists = $pdo->query("SHOW TABLES LIKE 'fee_types'")->rowCount() > 0;

    if (!$tableExists) {
        // Create the table if it doesn't exist
        $pdo->exec("CREATE TABLE IF NOT EXISTS fee_types (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            amount DECIMAL(10,2) NOT NULL DEFAULT 0.00,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )");
    }

    $fee_types = $pdo->query("SELECT * FROM fee_types ORDER BY name")->fetchAll();

    // If no fee types exist, create default ones
    if (empty($fee_types)) {
        $pdo->exec("INSERT INTO fee_types (name, amount, description) VALUES 
            ('School Fees', 5000.00, 'Annual school fees'),
            ('Feeding', 2000.00, 'School feeding program'),
            ('Transport', 1500.00, 'Transportation fees')");
        $fee_types = $pdo->query("SELECT * FROM fee_types ORDER BY name")->fetchAll();
    }
} catch (PDOException $e) {
    $fee_types = [];
    $error = "Error with fee types: " . $e->getMessage();
}

// Get fee payments if table exists
try {
    // Check if fee_payments table exists
    $tableExists = $pdo->query("SHOW TABLES LIKE 'fee_payments'")->rowCount() > 0;

    if (!$tableExists) {
        // Create the table if it doesn't exist
        $pdo->exec("CREATE TABLE IF NOT EXISTS fee_payments (
            id INT AUTO_INCREMENT PRIMARY KEY,
            student_id INT NOT NULL,
            amount DECIMAL(10,2) NOT NULL,
            payment_date DATE NOT NULL,
            term VARCHAR(20) NOT NULL,
            academic_year VARCHAR(20) NOT NULL,
            fee_type_id INT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (student_id) REFERENCES students(id) ON DELETE CASCADE,
            FOREIGN KEY (fee_type_id) REFERENCES fee_types(id) ON DELETE SET NULL
        )");
    }

    $fee_payments = $pdo->query("SELECT fp.*, s.full_name as student_name, ft.name as fee_type_name 
                                FROM fee_payments fp 
                                JOIN students s ON fp.student_id = s.id 
                                LEFT JOIN fee_types ft ON fp.fee_type_id = ft.id 
                                ORDER BY fp.payment_date DESC")->fetchAll();
} catch (PDOException $e) {
    $fee_payments = [];
    $error = "Error with fee payments: " . $e->getMessage();
}

// Function to get student fee summary
function getStudentFeeSummary($pdo, $student_id)
{
    try {
        // Check if tables exist
        $feeTypesExist = $pdo->query("SHOW TABLES LIKE 'fee_types'")->rowCount() > 0;
        $feePaymentsExist = $pdo->query("SHOW TABLES LIKE 'fee_payments'")->rowCount() > 0;

        if (!$feeTypesExist || !$feePaymentsExist) {
            return [];
        }

        // Get all fee types
        $fee_types = $pdo->query("SELECT * FROM fee_types")->fetchAll();

        // Get payments for this student
        $stmt = $pdo->prepare("SELECT fee_type_id, SUM(amount) as total_paid FROM fee_payments WHERE student_id = ? GROUP BY fee_type_id");
        $stmt->execute([$student_id]);
        $payments = $stmt->fetchAll(PDO::FETCH_KEY_PAIR);

        $summary = [];
        foreach ($fee_types as $fee_type) {
            $paid = isset($payments[$fee_type['id']]) ? $payments[$fee_type['id']] : 0;
            $remaining = $fee_type['amount'] - $paid;
            $summary[] = [
                'name' => $fee_type['name'],
                'total' => $fee_type['amount'],
                'paid' => $paid,
                'remaining' => max(0, $remaining)
            ];
        }

        return $summary;
    } catch (PDOException $e) {
        return [];
    }
}

// Get counts for dashboard
try {
    $teacher_count = $pdo->query("SELECT COUNT(*) FROM teachers")->fetchColumn();
    $student_count = $pdo->query("SELECT COUNT(*) FROM students")->fetchColumn();
    $class_count = $pdo->query("SELECT COUNT(*) FROM classes")->fetchColumn();
} catch (PDOException $e) {
    $teacher_count = 0;
    $student_count = 0;
    $class_count = 0;
    $error = "Error getting dashboard counts: " . $e->getMessage();
}

// Calculate capacity percentage
$total_capacity = $pdo->query("SELECT SUM(max_capacity) FROM classes")->fetchColumn();
if (!$total_capacity) {
    $total_capacity = $class_count * 30; // Fallback to default if max_capacity is not set
}
$capacity_percentage = $total_capacity > 0 ? round(($student_count / $total_capacity) * 100, 1) : 0;
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FISC-Manage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --text: #1f2937;
            --text-light: #6b7280;
            --white: #ffffff;
            --gray-light: #f9fafb;
            --glass: rgba(255, 255, 255, 0.9);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 0.75rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f3f4f6;
            color: var(--text);
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: var(--white);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .sidebar-header {
            padding: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-nav {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border-radius: var(--radius);
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .top-bar {
            background: var(--glass);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
            z-index: 90;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            color: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Views */
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 1.5rem;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        .stat-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        /* Tables */
        .table-container {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-header h2 {
            font-size: 1.25rem;
            color: var(--text);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .data-table th {
            background: #f9fafb;
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-table tr:hover {
            background: #f9fafb;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary { background: var(--primary); color: var(--white); }
        .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-success { background: #10b981; color: var(--white); }
        .btn-success:hover { background: #059669; }

        .btn-danger { background: #ef4444; color: var(--white); }
        .btn-danger:hover { background: #dc2626; }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.8rem; }

        /* Badges */
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-info { background: #dbeafe; color: #1e40af; }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .alert-success { background: #d1fae5; color: #065f46; }
        .alert-error { background: #fee2e2; color: #991b1b; }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--white);
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-md);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            transition: border-color 0.2s;
        }
        .form-control:focus { outline: none; border-color: var(--primary); ring: 2px solid var(--primary); }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; }
            .sidebar.active { left: 0; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-graduation-cap"></i> FISC-Manage
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" onclick="switchView('dashboard-view')">
                <i class="fas fa-home"></i> Dashboard
            </a>
            <a class="nav-item" onclick="switchView('teachers-view')">
                <i class="fas fa-chalkboard-teacher"></i> Teachers
            </a>
            <a class="nav-item" onclick="switchView('students-view')">
                <i class="fas fa-user-graduate"></i> Students
            </a>
            <a class="nav-item" onclick="switchView('classes-view')">
                <i class="fas fa-school"></i> Classes
            </a>
            <a class="nav-item" onclick="switchView('fees-view')">
                <i class="fas fa-money-bill-wave"></i> Fees
            </a>
            <a class="nav-item" onclick="switchView('store-view')">
                <i class="fas fa-store"></i> Store
            </a>
        </nav>
        <div class="sidebar-footer">
            <a href="logout.php" class="nav-item">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Bar -->
        <header class="top-bar">
            <button class="btn btn-sm" id="sidebar-toggle" style="background: transparent; color: var(--text); display: none;">
                <i class="fas fa-bars"></i>
            </button>
            <h2 id="page-title">Dashboard</h2>
            <div class="user-profile">
                <span><?php echo htmlspecialchars($_SESSION['admin_name']); ?></span>
                <div class="user-avatar">
                    <?php echo strtoupper(substr($_SESSION['admin_name'], 0, 1)); ?>
                </div>
            </div>
        </header>

        <div class="content-area">
            <?php if ($success): ?>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> <?php echo $success; ?>
                </div>
            <?php endif; ?>

            <?php if ($error): ?>
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i> <?php echo $error; ?>
                </div>
            <?php endif; ?>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="view-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #e0e7ff; color: var(--primary);">
                            <i class="fas fa-chalkboard-teacher"></i>
                        </div>
                        <div class="stat-info">
                            <h3><?php echo $teacher_count; ?></h3>
                            <p>Teachers</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #f3e8ff; color: var(--secondary);">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-info">
                            <h3><?php echo $student_count; ?></h3>
                            <p>Students</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #fef3c7; color: var(--accent);">
                            <i class="fas fa-school"></i>
                        </div>
                        <div class="stat-info">
                            <h3><?php echo $class_count; ?></h3>
                            <p>Classes</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #d1fae5; color: #10b981;">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <div class="stat-info">
                            <h3><?php echo $capacity_percentage; ?>%</h3>
                            <p>Capacity</p>
                        </div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2>Quick Actions</h2>
                    </div>
                    <div style="padding: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openModal('registerModal')">
                            <i class="fas fa-user-plus"></i> Register User
                        </button>
                        <button class="btn btn-success" onclick="openModal('classModal')">
                            <i class="fas fa-plus-circle"></i> Create Class
                        </button>
                        <button class="btn btn-primary" onclick="openModal('assignModal')">
                            <i class="fas fa-link"></i> Assign Teacher
                        </button>
                        <button class="btn btn-warning" style="color: white;" onclick="openModal('feeModal')">
                            <i class="fas fa-money-bill-wave"></i> Record Fees
                        </button>
                        <button class="btn btn-info" style="background: #0ea5e9; color: white;" onclick="openModal('announcementModal')">
                            <i class="fas fa-bullhorn"></i> Announcement
                        </button>
                    </div>
                </div>
            </div>

            <!-- Teachers View -->
            <div id="teachers-view" class="view-section">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Teachers Directory</h2>
                        <div style="display:flex; gap:1rem; align-items:center;">
                            <input type="text" id="search-teachers" placeholder="Search teachers..." class="form-control" style="width:200px;" onkeyup="filterTable('search-teachers', 'teachers-table')">
                            <button class="btn btn-primary btn-sm" onclick="openModal('registerModal'); switchTab('teacherTab')">
                                <i class="fas fa-plus"></i> Add Teacher
                            </button>
                        </div>
                    </div>
                    <table class="data-table" id="teachers-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Subject</th>
                                <th>Phone</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($teachers as $teacher): ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($teacher['full_name']); ?></td>
                                    <td><?php echo htmlspecialchars($teacher['email']); ?></td>
                                    <td><?php echo htmlspecialchars($teacher['subject'] ?? '-'); ?></td>
                                    <td><?php echo htmlspecialchars($teacher['phone'] ?? '-'); ?></td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="editTeacher(<?php echo $teacher['id']; ?>)">
                                            Edit
                                        </button>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Students View -->
            <div id="students-view" class="view-section">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Students Directory</h2>
                        <div style="display:flex; gap:1rem; align-items:center;">
                            <input type="text" id="search-students" placeholder="Search students..." class="form-control" style="width:200px;" onkeyup="filterTable('search-students', 'students-table')">
                            <button class="btn btn-primary btn-sm" onclick="openModal('registerModal'); switchTab('studentTab')">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                    </div>
                    <table class="data-table" id="students-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Class</th>
                                <th>Fee Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($students as $student): ?>
                                <?php $fee_summary = getStudentFeeSummary($pdo, $student['id']); 
                                      $school_fees_remaining = 0;
                                      foreach ($fee_summary as $fee) {
                                          if ($fee['name'] === 'School Fees') {
                                              $school_fees_remaining = $fee['remaining'];
                                              break;
                                          }
                                      }
                                ?>
                                <tr>
                                    <td><?php echo htmlspecialchars($student['full_name']); ?></td>
                                    <td><?php echo htmlspecialchars($student['email']); ?></td>
                                    <td><?php echo htmlspecialchars($student['class_name'] ?? 'Unassigned'); ?></td>
                                    <td>
                                        <?php if ($school_fees_remaining > 0): ?>
                                            <span class="badge badge-danger">Due: <?php echo number_format($school_fees_remaining); ?></span>
                                        <?php else: ?>
                                            <span class="badge badge-success">Paid</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm">Details</button>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Classes View -->
            <div id="classes-view" class="view-section">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Classes</h2>
                        <div style="display:flex; gap:1rem; align-items:center;">
                            <input type="text" id="search-classes" placeholder="Search classes..." class="form-control" style="width:200px;" onkeyup="filterTable('search-classes', 'classes-table')">
                            <button class="btn btn-success btn-sm" onclick="openModal('classModal')">
                                <i class="fas fa-plus"></i> New Class
                            </button>
                        </div>
                    </div>
                    <table class="data-table" id="classes-table">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Teacher</th>
                                <th>Enrollment</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($classes as $class): ?>
                                <tr>
                                    <td><strong><?php echo $class['class_code']; ?></strong></td>
                                    <td><?php echo htmlspecialchars($class['class_name']); ?></td>
                                    <td><?php echo htmlspecialchars($class['teacher_name'] ?? 'Unassigned'); ?></td>
                                    <td><?php echo $class['current_enrollment']; ?> / <?php echo $class['max_capacity']; ?></td>
                                    <td>
                                        <?php if ($class['current_enrollment'] >= $class['max_capacity']): ?>
                                            <span class="badge badge-danger">Full</span>
                                        <?php else: ?>
                                            <span class="badge badge-success">Open</span>
                                        <?php endif; ?>
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-sm" onclick="showClassDetails(<?php echo $class['class_id']; ?>)">Manage</button>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Fees View -->
            <div id="fees-view" class="view-section">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Fee Payments</h2>
                        <div style="display:flex; gap:1rem; align-items:center;">
                            <input type="text" id="search-fees" placeholder="Search fees..." class="form-control" style="width:200px;" onkeyup="filterTable('search-fees', 'fees-table')">
                            <button class="btn btn-warning btn-sm" style="color: white;" onclick="openModal('feeModal')">
                                <i class="fas fa-plus"></i> Record Payment
                            </button>
                        </div>
                    </div>
                    <table class="data-table" id="fees-table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Type</th>

            <!-- Store View -->
            <div id="store-view" class="view-section">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Store Management</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-primary btn-sm" onclick="openModal('addStoreItemModal')">Add Item</button>
                            <button class="btn btn-danger btn-sm" onclick="openModal('clearOrdersModal')">Clear Orders</button>
                        </div>
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <h3>Items</h3>
                        <table class="data-table" style="margin-bottom: 2rem;">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Stock</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($store_items as $item): ?>
                                    <tr>
                                        <td><?php echo htmlspecialchars($item['name']); ?></td>
                                        <td><?php echo ucfirst($item['category']); ?></td>
                                        <td>â‚¦<?php echo number_format($item['price'], 2); ?></td>
                                        <td><?php echo $item['quantity_available']; ?></td>
                                        <td>
                                            <?php if ($item['is_available']): ?>
                                                <span class="badge badge-success">Available</span>
                                            <?php else: ?>
                                                <span class="badge badge-danger">Unavailable</span>
                                            <?php endif; ?>
                                        </td>
                                        <td>
                                            <button class="btn btn-primary btn-sm" onclick="editStoreItem(<?php echo $item['id']; ?>)">Edit</button>
                                        </td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>

                        <h3>Recent Orders</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Student</th>
                                    <th>Item</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php foreach ($store_orders as $order): ?>
                                    <tr>
                                        <td>#<?php echo $order['id']; ?></td>
                                        <td><?php echo htmlspecialchars($order['student_name']); ?></td>
                                        <td><?php echo htmlspecialchars($order['item_name']); ?></td>
                                        <td>â‚¦<?php echo number_format($order['total_amount'], 2); ?></td>
                                        <td>
                                            <span class="badge badge-info"><?php echo ucfirst($order['status']); ?></span>
                                        </td>
                                        <td><?php echo date('M j, Y', strtotime($order['order_date'])); ?></td>
                                    </tr>
                                <?php endforeach; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

    <!-- Modals -->
    
    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Register User</h3>
                <button onclick="closeModal('registerModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                    <button class="btn btn-sm btn-primary" onclick="switchTab('teacherTab')">Teacher</button>
                    <button class="btn btn-sm btn-primary" onclick="switchTab('studentTab')">Student</button>
                </div>
                
                <div id="teacherTab" class="tab-content active">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="register_teacher" value="1">
                        <div class="form-group"><label>Full Name</label><input type="text" name="full_name" class="form-control" required></div>
                        <div class="form-group"><label>Email</label><input type="email" name="email" class="form-control" required></div>
                        <div class="form-group"><label>Password</label><input type="password" name="password" class="form-control" required></div>
                        <button type="submit" class="btn btn-primary">Register Teacher</button>
                    </form>
                </div>
                
                <div id="studentTab" class="tab-content" style="display:none;">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="register_student" value="1">
                        <div class="form-group"><label>Full Name</label><input type="text" name="full_name" class="form-control" required></div>
                        <div class="form-group"><label>Email</label><input type="email" name="email" class="form-control" required></div>
                        <div class="form-group"><label>Class</label>
                            <select name="class_id" class="form-control" required>
                                <?php foreach ($classes as $class): ?>
                                    <option value="<?php echo $class['class_id']; ?>"><?php echo $class['class_name']; ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class="form-group"><label>Password</label><input type="password" name="password" class="form-control" required></div>
                        <button type="submit" class="btn btn-primary">Register Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Class</h3>
                <button onclick="closeModal('classModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="create_class" value="1">
                    <div class="form-group"><label>Class Name</label><input type="text" name="class_name" class="form-control" required></div>
                    <div class="form-group"><label>Class Code</label><input type="text" name="class_code" class="form-control" required></div>
                    <button type="submit" class="btn btn-success">Create Class</button>
                <button onclick="closeModal('registerModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:1rem; margin-bottom:1rem;">
                    <button class="btn btn-sm btn-primary" onclick="switchTab('teacherTab')">Teacher</button>
                    <button class="btn btn-sm btn-primary" onclick="switchTab('studentTab')">Student</button>
                </div>
                
                <div id="teacherTab" class="tab-content active">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="register_teacher" value="1">
                        <div class="form-group"><label>Full Name</label><input type="text" name="full_name" class="form-control" required></div>
                        <div class="form-group"><label>Email</label><input type="email" name="email" class="form-control" required></div>
                        <div class="form-group"><label>Password</label><input type="password" name="password" class="form-control" required></div>
                        <button type="submit" class="btn btn-primary">Register Teacher</button>
                    </form>
                </div>
                
                <div id="studentTab" class="tab-content" style="display:none;">
                    <form method="POST" enctype="multipart/form-data">
                        <input type="hidden" name="register_student" value="1">
                        <div class="form-group"><label>Full Name</label><input type="text" name="full_name" class="form-control" required></div>
                        <div class="form-group"><label>Email</label><input type="email" name="email" class="form-control" required></div>
                        <div class="form-group"><label>Class</label>
                            <select name="class_id" class="form-control" required>
                                <?php foreach ($classes as $class): ?>
                                    <option value="<?php echo $class['class_id']; ?>"><?php echo $class['class_name']; ?></option>
                                <?php endforeach; ?>
                            </select>
                        </div>
                        <div class="form-group"><label>Password</label><input type="password" name="password" class="form-control" required></div>
                        <button type="submit" class="btn btn-primary">Register Student</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Class Modal -->
    <div id="classModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Class</h3>
                <button onclick="closeModal('classModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="create_class" value="1">
                    <div class="form-group"><label>Class Name</label><input type="text" name="class_name" class="form-control" required></div>
                    <div class="form-group"><label>Class Code</label><input type="text" name="class_code" class="form-control" required></div>
                    <button type="submit" class="btn btn-success">Create Class</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Assign Teacher Modal -->
    <div id="assignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Assign Teacher</h3>
                <button onclick="closeModal('assignModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="assign_teacher" value="1">
                    <div class="form-group">
                        <label>Class</label>
                        <select name="class_id" class="form-control" required>
                            <?php foreach ($classes as $class): ?>
                                <option value="<?php echo $class['class_id']; ?>"><?php echo $class['class_name']; ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Teacher</label>
                        <select name="teacher_id" class="form-control" required>
                            <?php foreach ($teachers as $teacher): ?>
                                <option value="<?php echo $teacher['id']; ?>"><?php echo $teacher['full_name']; ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Store Item Modal -->
    <div id="addStoreItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Store Item</h3>
                <button onclick="closeModal('addStoreItemModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="add_store_item" value="1">
                    <div class="form-group"><label>Name</label><input type="text" name="name" class="form-control" required></div>
                    <div class="form-group"><label>Category</label>
                        <select name="category" class="form-control" required>
                            <option value="book">Book</option>
                            <option value="stationery">Stationery</option>
                            <option value="uniform">Uniform</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Price</label><input type="number" name="price" class="form-control" required></div>
                    <div class="form-group"><label>Quantity</label><input type="number" name="quantity" class="form-control" required></div>
                    <button type="submit" class="btn btn-primary">Add Item</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Fee Modal -->
    <div id="feeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Record Fee Payment</h3>
                <button onclick="closeModal('feeModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="record_payment" value="1">
                    <div class="form-group">
                        <label>Student</label>
                        <select name="student_id" class="form-control" required>
                            <?php foreach ($students as $student): ?>
                                <option value="<?php echo $student['id']; ?>"><?php echo $student['full_name']; ?> (<?php echo $student['class_name']; ?>)</option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Fee Type</label>
                        <select name="fee_type_id" class="form-control" required>
                            <?php foreach ($fee_types as $type): ?>
                                <option value="<?php echo $type['id']; ?>"><?php echo $type['name']; ?> - GHC<?php echo $type['amount']; ?></option>
                            <?php endforeach; ?>
                        </select>
                    </div>
                    <div class="form-group"><label>Amount (GHC)</label><input type="number" step="0.01" name="amount" class="form-control" required></div>
                    <div class="form-group"><label>Date</label><input type="date" name="payment_date" class="form-control" value="<?php echo date('Y-m-d'); ?>" required></div>
                    <div class="form-group"><label>Term</label>
                        <select name="term" class="form-control" required>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Academic Year</label><input type="text" name="academic_year" class="form-control" value="<?php echo date('Y') . '/' . (date('Y')+1); ?>" required></div>
                    <button type="submit" class="btn btn-warning" style="color:white;">Record Payment</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Announcement Modal -->
    <div id="announcementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Announcement</h3>
                <button onclick="closeModal('announcementModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST" id="announcementForm">
                    <input type="hidden" name="create_announcement" value="1">
                    <div class="form-group">
                        <label>Recipient</label>
                        <select name="recipient_type" id="recipient_type" class="form-control" required>
                            <option value="students">Students</option>
                            <option value="teachers">Teachers</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Title</label><input type="text" name="title" id="announcement_title" class="form-control" required></div>
                    <div class="form-group"><label>Message</label><textarea name="message" id="announcement_message" class="form-control" rows="4" required></textarea></div>
                    <div class="form-group"><label>Priority</label>
                        <select name="priority" class="form-control">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-info" style="color:white;">Send Announcement</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Teacher Modal -->
    <div id="editTeacherModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Teacher</h3>
                <button onclick="closeModal('editTeacherModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="update_teacher" value="1">
                    <input type="hidden" name="teacher_id" id="edit_teacher_id">
                    <div class="form-group"><label>Full Name</label><input type="text" name="full_name" id="edit_teacher_name" class="form-control" required></div>
                    <div class="form-group"><label>Email</label><input type="email" name="email" id="edit_teacher_email" class="form-control" required></div>
                    <div class="form-group"><label>Phone</label><input type="text" name="phone" id="edit_teacher_phone" class="form-control"></div>
                    <div class="form-group"><label>Subject</label><input type="text" name="subject" id="edit_teacher_subject" class="form-control"></div>
                    <button type="submit" class="btn btn-primary">Update Teacher</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Store Item Modal -->
    <div id="editStoreItemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Store Item</h3>
                <button onclick="closeModal('editStoreItemModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST">
                    <input type="hidden" name="update_store_item" value="1">
                    <input type="hidden" name="item_id" id="edit_item_id">
                    <div class="form-group"><label>Name</label><input type="text" name="name" id="edit_item_name" class="form-control" required></div>
                    <div class="form-group"><label>Category</label>
                        <select name="category" id="edit_item_category" class="form-control" required>
                            <option value="book">Book</option>
                            <option value="stationery">Stationery</option>
                            <option value="uniform">Uniform</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Price</label><input type="number" name="price" id="edit_item_price" class="form-control" required></div>
                    <div class="form-group"><label>Quantity</label><input type="number" name="quantity" id="edit_item_quantity" class="form-control" required></div>
                    <div class="form-group">
                        <label><input type="checkbox" name="is_available" id="edit_item_available" value="1"> Available</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Item</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Clear Orders Modal -->
    <div id="clearOrdersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Clear Old Orders</h3>
                <button onclick="closeModal('clearOrdersModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <form method="POST" onsubmit="return confirm('Are you sure you want to clear these orders? This cannot be undone.');">
                    <input type="hidden" name="clear_old_orders" value="1">
                    <div class="form-group">
                        <label>Clear orders older than:</label>
                        <select name="days_old" class="form-control">
                            <option value="7">1 Week</option>
                            <option value="30" selected>1 Month</option>
                            <option value="90">3 Months</option>
                            <option value="180">6 Months</option>
                            <option value="365">1 Year</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Only completed and cancelled orders will be deleted.
                    </div>
                    <button type="submit" class="btn btn-danger">Clear Orders</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Class Details Modal -->
    <div id="classDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Class Details</h3>
                <button onclick="closeModal('classDetailModal')" style="background:none;border:none;cursor:pointer;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="classDetailContent">
                <div style="text-align:center; padding:2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>
            </div>
        </div>
    </div>

    <script>
        function switchView(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const titles = {
                'dashboard-view': 'Dashboard',
                'teachers-view': 'Teachers',
                'students-view': 'Students',
                'classes-view': 'Classes',
                'fees-view': 'Fees',
                'store-view': 'Store Management'
            };
            document.getElementById('page-title').innerText = titles[viewId];
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.getElementById(tabId).style.display = 'block';
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // AJAX Functions
        async function editTeacher(teacherId) {
            try {
                const response = await fetch(`get_teacher_details.php?teacher_id=${teacherId}`);
                const data = await response.json();
                if (data.success) {
                    const teacher = data.teacher;
                    document.getElementById('edit_teacher_id').value = teacher.id;
                    document.getElementById('edit_teacher_name').value = teacher.full_name;
                    document.getElementById('edit_teacher_email').value = teacher.email;
                    document.getElementById('edit_teacher_phone').value = teacher.phone || '';
                    document.getElementById('edit_teacher_subject').value = teacher.subject || '';
                    openModal('editTeacherModal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading teacher data');
            }
        }

        async function showClassDetails(classId) {
            try {
                openModal('classDetailModal');
                document.getElementById('classDetailContent').innerHTML = '<div style="text-align:center; padding:2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
                
                const response = await fetch(`get_class_details.php?class_id=${classId}`);
                const data = await response.json();

                if (data.success) {
                    const classInfo = data.class;
                    const students = data.students;
                    
                    let studentsHtml = '<p>No students enrolled</p>';
                    if (students.length > 0) {
                        studentsHtml = students.map(s => `
                            <div style="display:flex; justify-content:space-between; padding:0.5rem; border-bottom:1px solid #eee;">
                                <span>${s.full_name}</span>
                                <form method="POST" onsubmit="return confirm('Remove student?')" style="display:inline;">
                                    <input type="hidden" name="remove_student" value="1">
                                    <input type="hidden" name="student_id" value="${s.id}">
                                    <input type="hidden" name="class_id" value="${classId}">
                                    <button type="submit" class="btn btn-danger btn-sm"><i class="fas fa-times"></i></button>
                                </form>
                            </div>
                        `).join('');
                    }

                    document.getElementById('classDetailContent').innerHTML = `
                        <div style="margin-bottom:1rem;">
                            <strong>Class:</strong> ${classInfo.class_name} (${classInfo.class_code})<br>
                            <strong>Teacher:</strong> ${classInfo.teacher_name || 'None'}<br>
                            <strong>Enrollment:</strong> ${classInfo.current_enrollment}/${classInfo.max_capacity}
                        </div>
                        <h4>Students</h4>
                        <div style="max-height:300px; overflow-y:auto;">${studentsHtml}</div>
                    `;
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('classDetailContent').innerHTML = '<p class="text-danger">Error loading details</p>';
            }
        }

        async function editStoreItem(itemId) {
            try {
                const response = await fetch(`get_store_item.php?item_id=${itemId}`);
                const data = await response.json();
                if (data.success) {
                    const item = data.item;
                    document.getElementById('edit_item_id').value = item.id;
                    document.getElementById('edit_item_name').value = item.name;
                    document.getElementById('edit_item_category').value = item.category;
                    document.getElementById('edit_item_price').value = item.price;
                    document.getElementById('edit_item_quantity').value = item.quantity_available;
                    document.getElementById('edit_item_available').checked = item.is_available == 1;
                    openModal('editStoreItemModal');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading item data');
            }
        }
        function filterTable(inputId, tableId) {
            var input, filter, table, tr, td, i, j, txtValue;
            input = document.getElementById(inputId);
            filter = input.value.toUpperCase();
            table = document.getElementById(tableId);
            tr = table.getElementsByTagName("tr");

            for (i = 0; i < tr.length; i++) {
                // Skip header row
                if (tr[i].getElementsByTagName("th").length > 0) {
                    continue;
                }
                
                var display = false;
                td = tr[i].getElementsByTagName("td");
                for (j = 0; j < td.length; j++) {
                    if (td[j]) {
                        txtValue = td[j].textContent || td[j].innerText;
                        if (txtValue.toUpperCase().indexOf(filter) > -1) {
                            display = true;
                            break;
                        }
                    }
                }
                
                if (display) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    </script>
</body>
</html>